# Воркфлоу після офера (Sales → Proformas → Invoices)

Опис кроків від офера до проформи, інвойсів під проформою та (за потреби) підтвердженого бронювання.

---

## 1. Після створення офера

- **Офер** створюється з резервації (Manage → Create/Send Offer) і **зв’язується з резервацією** (`reservation_id`).
- Резервація отримує статус **offered**.
- В календарі залишається **hold** (резервація), не підтверджене бронювання.

---

## 2. Додавання проформи (Add Proforma)

- З вкладки **Offers** або з модалки **Manage** (резервація з офером) натискають **Add Proforma** (раніше: Create Invoice).
- Відкривається модалка **Add Proforma**: дані з офера (клієнт, дати, сума) заповнені лише для перегляду.
- Менеджер вводить **номер проформи** і **обов’язково завантажує PDF проформи** (drag-and-drop або вибір файлу).
- При збереженні:
  - у таблиці **invoices** створюється запис з `document_type = 'proforma'`, `offer_id`, `booking_id` (резервація), та `file_url` (URL PDF у Storage).
  - Проформа з’являється у вкладці **Sales → Proformas**.

Логіка підтвердження оплати бухгалтером для проформ **не використовується**: проформи лише фіксуються в Sales.

---

## 3. Розділ «Проформи» в Sales

- У **Sales** з’явилась вкладка **Proformas** (Проформи).
- Список усіх проформ (`document_type = 'proforma'`): номер, клієнт, дата, сума, посилання на PDF.
- Кожен рядок має кнопку **Add Invoice** (Додати інвойс).
- Рядок можна **розгорнути** (chevron): під ним показуються всі інвойси, створені під цією проформою.

---

## 4. Додавання інвойсу до проформи (Add Invoice)

- Натискання **Add Invoice** на рядку проформи відкриває модалку **Add Invoice**.
- Дані з проформи (клієнт, дати, сума) підставлені лише для перегляду.
- Менеджер вводить **номер інвойсу** і **обов’язково завантажує PDF інвойсу**.
- При збереженні створюється запис у **invoices** з `document_type = 'invoice'`, `proforma_id` (ID батьківської проформи), `file_url` та тими ж даними, що й у проформи. Інвойс з’являється під цією проформою в розгорнутому списку.

Під одну проформу можна додати кілька інвойсів.

---

## 5. Оплата інвойсу (Mark as Paid)

- Статус інвойсу змінюють на **Paid** (перемикач у списку інвойсів у Accounting).
- Виконати це може лише користувач з відділом **accounting** (перевірка в RPC).
- При зміні на **Paid** викликається RPC **`mark_invoice_paid_and_confirm_booking(invoice_id)`**.

Що робить RPC (атомарно):

1. **Інвойс** → `status = 'Paid'`.
2. За офером (з проформи/інвойсу) завантажується **резервація** (`offer.reservation_id`).
3. **Створюється запис у таблиці `bookings`** (підтверджене бронювання).
4. Резервація-переможець → `status = 'won'`, офер-переможець → `status = 'Accepted'`.
5. Інші резервації з тим самим об’єктом і перекриваючими датами → `status = 'lost'`, їхні офери → `status = 'Lost'`.

Функція повертає **ID створеного бронювання** (`bookings.id`).

---

## 6. Після Mark as Paid

- **Календар**: підтверджене бронювання береться з таблиці **bookings** і відображається як заброньовані дати (не як hold).
- **Facility**: для нового бронювання створюються задачі (наприклад, Einzug) через `createFacilityTasksForBooking`.
- Hold’и зі статусом **lost** у календарі більше не показуються як активні.

---

## Схема ланцюжка

```
Reservation (hold)  →  Offer (reservation_id)  →  Proforma (document_type='proforma', offer_id, file_url)
                                                              ↓
                                                   Sales → Proformas → Add Invoice
                                                              ↓
                                                   Invoice (document_type='invoice', proforma_id, file_url)
                                                              ↓
                                              Mark as Paid → RPC → Booking (bookings table)
                                                              → reservation 'won', offer 'Accepted'
                                                              → overlapping reservations 'lost', their offers 'Lost'
```

---

## Важливо

- **Проформа** створюється з офера (кнопка **Add Proforma** з офера/резервації з офером); у неї зберігаються **offer_id** та **booking_id** для подальшого Mark as Paid.
- **Інвойси** під проформою створюються в Sales → Proformas → Add Invoice; вони зв’язані з проформою через **proforma_id**.
- **Mark as Paid** доступний лише для **accounting**; без цього кроку бронювання в `bookings` не створюється і в календарі не з’являється.
- Підтверджене бронювання в календарі з’являється **тільки після** того, як відповідний інвойс позначено як **Paid** (і RPC створив запис у `bookings`).

# Налаштування OCR через Google Gemini API

## Крок 1: Отримати API ключ від Google Gemini

1. Перейдіть на [Google AI Studio](https://aistudio.google.com/app/apikey)
2. Створіть новий API ключ або використайте існуючий
3. Скопіюйте ключ (він має виглядати як `AIza...`)

## Крок 2: Створити Edge Function в Supabase Dashboard

1. Відкрийте [Supabase Dashboard](https://supabase.com/dashboard)
2. Виберіть ваш проект
3. Перейдіть в розділ **Edge Functions** (в лівому меню)
4. Натисніть кнопку **"Create a new function"**
5. **Function Name:** `ocr-invoice`
6. **Template:** Оберіть "Blank Function"
7. Натисніть **"Create function"**

## Крок 3: Вставити код Edge Function

1. Відкрийте файл `supabase/functions/ocr-invoice/index.ts` з цього проекту
2. Скопіюйте весь код з файлу
3. Вставте код в редактор Edge Function в Supabase Dashboard
4. Натисніть **"Deploy"** або **"Save"**

## Крок 4: Додати змінну оточення GEMINI_API_KEY

1. Відкрийте функцію `ocr-invoice` в Supabase Dashboard
2. Перейдіть в розділ **Settings** або **Function Configuration**
3. Знайдіть секцію **Environment Variables** або **Secrets**
4. Додайте нову змінну:
   - **Name:** `GEMINI_API_KEY`
   - **Value:** ваш API ключ від Google Gemini (який ви скопіювали в Крок 1)
5. Натисніть **"Save"** або **"Add"**

## Крок 5: Налаштування безпеки Edge Function

**ВАЖЛИВО:** Після деплою функції:

1. Відкрийте функцію `ocr-invoice` в Supabase Dashboard
2. Перейдіть в розділ **Settings** або **Function Configuration**
3. Знайдіть опцію **"Verify JWT"** або **"Verify JWT with legacy secret"**
4. **ВИМКНІТЬ** цю опцію (перемикач має бути вимкнений/OFF)
5. Натисніть **"Save changes"**

**Чому це потрібно:**
- Edge Function використовує GEMINI_API_KEY всередині для виклику Gemini API
- Функція потребує авторизації через Supabase session token (передається в заголовку Authorization)
- Якщо "Verify JWT" увімкнено, функція може відхиляти запити

## Крок 6: Тестування

1. Відкрийте платформу в браузері
2. Перейдіть в **Facility → Warehouse → Add inventory**
3. Завантажте файл (PDF, JPG, PNG) з інвойсом
4. Натисніть кнопку **"Recognize with OCR"**
5. Перевірте, чи дані розпізнаються правильно
6. При потребі відредагуйте вручну
7. Виберіть склад та збережіть

## Troubleshooting

### Помилка "GEMINI_API_KEY not configured"
- Перевірте, що змінна оточення `GEMINI_API_KEY` додана в налаштуваннях Edge Function
- Перевірте, що значення правильне (без пробілів на початку/кінці)
- Спробуйте передеплоїти функцію після додавання змінної

### Помилка "Gemini API error: 400" або "401"
- Перевірте, що API ключ правильний та активний
- Перевірте, що у вас є доступ до Gemini API (може бути обмеження по регіону)
- Перевірте квоти використання API в Google Cloud Console

### Помилка "Not authenticated"
- Перевірте, що ви залогінені в платформі
- Спробуйте вийти та зайти знову
- Перевірте, що Supabase session активний

### Помилка "Function not found" або 404
- Перевірте, що функція названа точно `ocr-invoice`
- Перевірте, що функція задеплоєна (статус "Active")
- Перевірте URL функції в логах браузера (має бути `https://[project-ref].supabase.co/functions/v1/ocr-invoice`)

### OCR не розпізнає дані правильно
- Переконайтеся, що файл має хорошу якість (не розмитий, добре видно текст)
- Спробуйте інший формат (PDF замість JPG або навпаки)
- Перевірте, що інвойс містить чіткий текст (не рукописний)
- Можна вручну відредагувати розпізнані дані перед збереженням

### Дані розпізнаються, але не зберігаються
- Перевірте, що вибрано склад (warehouse)
- Перевірте, що всі обов'язкові поля заповнені (назва товару, кількість)
- Перевірте логи в консолі браузера (F12) для деталей помилки

## URL функції

Після деплою функція буде доступна за адресою:
```
https://[your-project-ref].supabase.co/functions/v1/ocr-invoice
```

Цей URL автоматично використовується в коді через `VITE_SUPABASE_URL`.

## Підтримувані формати файлів

- **PDF** - найкраще для інвойсів
- **JPG/JPEG** - фотографії інвойсів
- **PNG** - скріншоти або скани інвойсів

## Що розпізнає OCR

- **Назва товару** (name)
- **Кількість** (quantity)
- **Одиниця виміру** (unit: pcs, kg, m, etc.)
- **Ціна за одиницю** (price)
- **Артикул/SKU** (якщо є)
- **Номер інвойсу** (invoiceNumber)
- **Дата покупки** (purchaseDate)
- **Назва магазину/постачальника** (vendor)

Всі дані можна відредагувати вручну перед збереженням на склад.

